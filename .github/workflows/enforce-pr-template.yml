name: Enforce PR Template

on:
  workflow_call:

jobs:
  validate-pr-template:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR Template
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || "";
            const prNumber = pr.number;

            console.log("PR Body:", body);

            const errors = [];

            // Extract Target Branch
            const targetMatch = body.match(/\*\*Target Branch:\*\*\s*(.*)/);
            const targetBranch = targetMatch ? targetMatch[1].trim() : "";

            if (!targetBranch) {
              errors.push("**Target Branch** is missing");
            } else if (!["master", "main"].includes(targetBranch)) {
              errors.push("**Target Branch** must be either `master` or `main`");
            }

            // Extract Source Branch
            const sourceMatch = body.match(/\*\*Source Branch:\*\*\s*(.*)/);
            const sourceBranch = sourceMatch ? sourceMatch[1].trim() : "";
            if (!sourceBranch) {
              errors.push("**Source Branch** is missing");
            }

            if (errors.length > 0) {
              let msg = "## PR Template Validation Failed\n\n";
              msg += errors.join("\n") + "\n\n";
              msg += "Please correct the PR description.\n\n";
              msg += "**Required format:**\n";
              msg += "```\n";
              msg += "## Branch Information\n";
              msg += "**Target Branch:** master | main\n";
              msg += "**Source Branch:** <branch>\n";
              msg += "```";

              // Add comment to PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: msg
              });

              core.setFailed("PR template missing or invalid fields");
            } else {
              console.log("PR template validation passed");
            }
